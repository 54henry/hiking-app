<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>webstylesymbols</title>
  <!-- <link rel="stylesheet" href="../../arcgis-js-api-4/esri/css/main.css">
  <script data-dojo-config="async: true" src="../../arcgis-js-api-4/dojo/dojo.js"></script>
 -->
 <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">
 <script src="https://js.arcgis.com/4.6/"></script>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      color: white;
      font-family: "Avenir Next W01", "Arial", sans-serif;
    }

    #paneDiv {
      position: absolute;
      bottom: 17px;
      width: 100%;
      padding: 20px 0;
      z-index: 1;
      text-align: center;
    }

    button {
      background: white;
      padding: 7px;
      border: 1px solid #005e95;
      font-size: 0.9em;
      margin: 5px;
      color: #005e95;
    }

    button:hover {
      background: #005e95;
      color: white;
      cursor: pointer;
    }
  </style>
  <script>
    require([
      "esri/Map",
      "esri/WebScene",
      "esri/views/SceneView",

      "esri/layers/SceneLayer",
      "esri/renderers/UniqueValueRenderer",
      "esri/symbols/WebStyleSymbol",
      "dojo/on",
      "dojo/query",
      "dojo/dom",
      "esri/config",
      "esri/request",

      "esri/Graphic",
      "esri/geometry/Point",

      "esri/layers/GraphicsLayer",
      "esri/symbols/PointSymbol3D",
      "esri/symbols/IconSymbol3DLayer",
      "esri/symbols/MeshSymbol3D",
      "esri/symbols/FillSymbol3DLayer",
      "esri/renderers/SimpleRenderer",
      "dojo/domReady!"
    ], function (
      Map, WebScene, SceneView, SceneLayer,
      UniqueValueRenderer,
      WebStyleSymbol,
      on, query, dom,
      esriConfig, esriRequest,
      Graphic, Point, GraphicsLayer, PointSymbol3D, IconSymbol3DLayer, MeshSymbol3D, FillSymbol3DLayer, SimpleRenderer
    ) {

        var map = new Map({
          basemap: "gray",
          ground: "world-elevation"
        });

        var position = {
          latitude: 45.482725,
          longitude: -73.577610,
          z: 1000
        };

        var view = new SceneView({
          container: "viewDiv",
          map: map,

          qualityProfile: "high",

          environment: {
            lighting: {
              directShadowsEnabled: true,
              ambientOcclusionEnabled: true,
              //date: "Wed Mar 15 2017 15:09:39 GMT-0800 (PST)"
            }
          },

          camera: {
            position: position,
            tilt: 80,
            heading: 0
          }
        });

        var sceneLayer = new SceneLayer({
          url: "https://tiles.arcgis.com/tiles/P3ePLMYs2RVChkJx/arcgis/rest/services/Building_Montreal/SceneServer",
          renderer: new SimpleRenderer({
            symbol: new MeshSymbol3D({
              symbolLayers: [
                new FillSymbol3DLayer({
                  material: {
                    color: [219, 180, 129],
                    colorMixMode: "replace"
                  }
                })
              ]
            })
          })
        });

        map.add(sceneLayer);

        esriConfig.request.corsEnabledServers.push("https://api.flickr.com/");
        esriConfig.request.corsEnabledServers.push("https://farm5.staticflickr.com/");
        esriConfig.request.corsEnabledServers.push("https://farm3.staticflickr.com/");
        esriConfig.request.corsEnabledServers.push("https://farm1.staticflickr.com/");
        esriConfig.request.corsEnabledServers.push("https://farm2.staticflickr.com/");
        esriConfig.request.corsEnabledServers.push("https://farm4.staticflickr.com/");
        var url = "https://api.flickr.com/services/rest/?" +
          "method=flickr.photos.search&api_key=d2eeadac35a3dfc3fb64a92e7c792de0&privacy_filter=1&accuracy=16" +
          "&has_geo=true&lat=" + position.latitude + "&lon=" + position.longitude + "&radius=4&per_page=100";

        esriRequest(url, {
          responseType: "xml"
        }).then(function (response) {
          var photos = response.data.getElementsByTagName("photo");
          var imagesLayer = new GraphicsLayer({
            minScale: 40000,
            maxScale: 1000,
            elevationInfo: {
              mode: "relative-to-scene"
            }
          });
          function getRequest(i) {
            var photo = photos[i];
            esriRequest("https://api.flickr.com/services/rest/?method=flickr.photos.geo.getLocation&api_key=d2eeadac35a3dfc3fb64a92e7c792de0&photo_id=" + photo.getAttribute("id"),
              { responseType: "xml" }).then(function (response) {
                var location = response.data.getElementsByTagName("location")[0];
                var urlPicture = "https://farm" + photo.getAttribute("farm") + ".staticflickr.com/" + photo.getAttribute("server") + "/" + photo.getAttribute("id") + "_" + photo.getAttribute("secret") + ".jpg";
                //console.log(urlPicture);
                var billboard = new PointSymbol3D({
                  symbolLayers: [new IconSymbol3DLayer({
                    size: 60,
                    resource: { href: urlPicture }
                  })],
                  lift: {
                    screenHeight: 70,
                    maxWorldHeight: 600
                  },
                  leaderLine: {
                    size: 1,
                    color: [0, 0, 0, 0.5]
                  }
                });

                var point = new Point({
                  latitude: location.getAttribute("latitude"),
                  longitude: location.getAttribute("longitude")
                });

                var graphic = new Graphic({
                  geometry: point,
                  symbol: billboard
                });
                imagesLayer.add(graphic);
                console.log(i);
                if (i < photos.length) {
                  i++;
                  getRequest(i);
                }
              })
              .otherwise(function (err) {
                console.log(err);
              });

          }

          /*  access token: 4775030223.a6ccd90.717de196c7fb40e3be01b514287d8de1
              code: 5e2baa09e5a348fda475bee8a5f2c6af*/
          getRequest(0);
          console.log(imagesLayer);
          map.add(imagesLayer);
        }).otherwise(function (err) {
          console.log(err);
        });
      });

  </script>
</head>

<body>
  <div id="viewDiv"></div>
</body>

</html>
